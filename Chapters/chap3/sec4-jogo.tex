%!TEX root = ../../tcc.tex

\newpage
\section{Jogo da troca de arquivos}
\label{sec:titfortat}

Nesta altura do processo de download de um \gls*{torrent}, o Transmission já realizou
muitos procedimentos. Tudo começou com a adição de um \gls*{torrentfile} ao programa,
que leu seus dados e identificou os endereços de \glspl*{tracker}; então, entrou em
contato com eles, que respondeu com uma lista de \glspl*{peer} que já estão no
\gls*{swarm}. Ou seja, até agora, não foi baixado nenhum byte sequer do arquivo contido
no pacote do \gls*{torrent}.

Nesta seção, mostraremos o protocolo de mensagens para trocas de arquivos entre esses
\glspl*{peer} dessa lista e os algoritmos do BitTorrent dessas trocas.

\subsection*{Estados dos nós e informações}

Existem 2 características independentes que formam as possibilidades de estados que um
\gls*{peer} pode assumir enquanto participa de um \gls*{swarm}:

\begin{itemize}
    \item \emph{choking} (estrangulamento): se um \gls*{peer} \textbf{A} estrangulará a
        conexão com outro \gls*{peer} \textbf{B} (\emph{choked}) ou a deixará normal
        (\emph{unchoked}).

    \item \emph{interest} (interesse): se um \gls*{peer} \textbf{A} terá interesse em
        um \gls*{peer} \textbf{B} (\emph{interested}) ou não (\emph{not interested})
\end{itemize}

Uma nova conexão entre \glspl*{peer} inicia em \emph{choked} e \emph{not interested} em
ambos os sentidos, ou seja, com \textbf{A} e \textbf{B} estrangulando suas conexões
mutuamente e sem interesse no outro. Esses estados ditarão todas as estratégias de troca
de partes entre \glspl*{peer}.

Outra informação utilizada é o \emph{bitfield}, que é um mapa de bits onde cada bit
representa uma parte que o \gls*{peer} já possui.

\subsection*{Mensagens}

O protocolo é definido por 12 mensagens e 2 tipos de assinaturas. Essas mensagens são
enviadas entre \glspl*{peer} e serve para estes tomarem conhecimento da situação de
download de um \gls*{torrent}. A primeira assinatura é exclusiva da mensagem de
handshake, enquanto todas as outras seguem o mesmo padrão.

\subsubsection*{handshake}

assinatura: \bverb|<comprimento do header><header><bytes reservados><info_hash><peer_id>|

O \emph{handshake} (aperto de mãos) é a primeira mensagem a ser enviada por um
\gls*{peer} que recém-chegado à rede.

\begin{itemize}
    \item \bverb|<comprimento do header>|: comprimento da string \bverb|<header>|,
        representado em binário por 1 byte. O comprimento oficial é 19.

    \item \bverb|<header>|: \gls*{string} identificadora do protocolo. Na versão 1.0 do
        protocolo BitTorrent, a \gls*{string} oficial é \sverb|BitTorrent protocol|.

    \item \bverb|<bytes reservados>|: seção de 8 bytes (= 64 bits) reservados para a
        habilitação de funcionalidades extras do protocolo. Um e-mail enviado pelo
        criador do BitTorrent Bram Cohen \cite{wikitheory:reserved-bytes} sugere que os
        bits menos significativos sejam usados primeiro, para que os mais significativos
        possam ser usados para alterar o significado dos bits finais. A implementação de
        cada uma das funcionalidades não-oficiais depende do programa cliente. A tabela
        abaixo mostra os bits e seus respectivos usos, oficiais (*) ou não-oficiais.

        \begin{center}
            \begin{tabular}{ | c | c |}
            \hline
            \textbf{Bit} & \textbf{Uso}                         \\ \hline
            1       & Azureus Extended Messaging                \\ \hline
            1-16    & BitComet Extension protocol               \\ \hline
            21      & BitTorrent Location-aware Protocol 1.0    \\ \hline
            44      & Extension protocol                        \\ \hline
            47-48   & Extension Negotiation Protocol            \\ \hline
            61      & NAT Traversal                             \\ \hline
            62      & Fast Peers*                               \\ \hline
            63      & XBT Peer Exchange                         \\ \hline
            64      & DHT* ou XBT Metadata Exchange             \\ \hline
            \end{tabular}
        \end{center}

    \item \bverb|<info_hash>|: o ID do \gls*{torrent}, que é a \gls*{string}
        \gls*{hashvalue} de 20 bytes resultante da \gls*{hashfunction} SHA-1, com
        \gls*{urlencode}, do valor da chave \bverb|info| do arquivo \gls*{torrentfile};

    \item \bverb|<peer_id>|: ID único do cliente, que é uma \gls*{string} de 20 bytes,
        geralmente sendo o mesmo valor \bverb|peer_id| enviado nas requisições ao
        \gls*{tracker}, prefixado pelas informações como o nome do programa cliente e a
        sua versão. Por exemplo, o Transmission envia o prefixo \sverb|-TR2820-...|
\end{itemize}

Esse mensagem é enviada imediatamente pelo \gls*{peer} que inicia uma conexão. O
receptor deve responder, assim que ver o ID do \gls*{torrent} na seção de
\bverb|info_hash| da mensagem, com o seu \bverb|peer_id|. A conexão deve ser fechada em
dois casos: pelo receptor, se ele receber a mensagem para um ID de \gls*{torrent}
desconhecido para si, ou pelo iniciador, caso o \bverb|peer_id| recebido como resposta
seja diferente daquele indicado na lista de \glspl*{peer} recebida do \gls*{dht}.

\subsubsection*{keep-alive}

assinatura: \bverb|<prefixo de tamanho=0000>|

A mensagem de \emph{keep-alive} (``mantenha viva'' em português literal) serve para
manter uma conexão aberta caso nenhuma outra mensagem seja enviada num período de tempo
(geralmente, 2 minutos).

Assim como as outras mensagens, esta mensagem usa a assinatura
\bverb|<prefixo de tamanho><ID da mensagem><dados>|.

\begin{itemize}
    \item \bverb|<prefixo de tamanho>|: valor de 4 bytes em \emph{big} \gls{endian}

    \item \bverb|<ID da mensagem>|: decimal de 1 byte

    \item \bverb|<dados>|: dados a serem enviados ao outro \gls*{peer}, dependente da
        mensagem
\end{itemize}

Porém, não possui ID da mensagem nem dados a serem enviados, possuindo tamanho 0.

\subsubsection*{choke e unchoke}

choke: \bverb|<prefixo de tamanho=0001><ID da mensagem=0>| \\
unchoke: \bverb|<prefixo de tamanho=0001><ID da mensagem=1>|

Estas mensagens servem para indicar que a mudança de estado de choking que o \gls*{peer}
remetente tratará o receptor. Ou seja, o receptor \emph{choked} não terá suas
requisições atendidas, ao contrário de quando estiver \emph{unchoked}.

\subsubsection*{interested e not interested}

interested: \bverb|<prefixo de tamanho=0001><ID da mensagem=2>| \\
not interested: \bverb|<prefixo de tamanho=0001><ID da mensagem=3>|

Assim como as mensagens de \emph{choke}, estas 2 mensagens também servem para indicar a
mudança de estado, desta vez sendo a mudança de interesse que o \gls*{peer} remetente
terá no receptor.

\subsubsection*{have}

have: \bverb|<prefixo de tamanho=0005><ID da mensagem=4><dados=i-ésima parte>|

A definição é que esta mensagem avisa um \gls*{peer} que a $i$-ésima parte do
\gls*{torrent} foi baixada pelo remetente e verificada através de \gls*{hashvalue}.
Porém, não necessariamente é usada dessa forma.

Uma implementação desta mensagem pode fazer com que um \gls*{peer}, que acabou de
adquirir a parte, não emitir aviso para todos os \gls*{peers} vizinhos que já a
possuem, diminuindo o \gls{overhead} de mensagens do protocolo. Por outro lado, enviar
esse aviso pode ajudar na determinação de qual parte é mais rara.

\subsubsection*{bitfield}

bitfield: \bverb|<prefixo de tamanho=0001+X><ID da mensagem=5><dados=mapa de bits>|

O BitTorrent usa bitfields (mapas de bits) em \emph{big} \gls*{endian} para representar
na forma de \emph{flags} quais partes de um \gls*{torrent} já possui.

Esta mensagem só deve ser enviada imediatamente após o processo de \emph{handshake}
terminar e antes de qualquer outra mensagem. Se o \gls*{peer} não tiver nenhuma parte o
campo de dados pode ser omitido. Como bitfields variam de acordo com o tamanho total do
\gls*{torrent}, o comprimento da mensagem é variável, onde $X$ é o comprimento do
bitfield, acrescentado de alguns bits 0 de sobra no seu final (\emph{spare bits}).

Um bitfield de comprimento errado ou sem bits de sobra no final são considerados erros,
fazendo com que as respectivas conexões devam ser fechadas.

\subsubsection*{request}

request: \bverb|<prefixo de tamanho=0013><ID da mensagem=6><dados=<índice><início><tamanho>>|

Conforme foi explicado na subseção ~\ref{subsec:partes}, um \gls*{torrent} divide os
dados em partes. Porém, a transmissão não se dá enviando partes inteiras, mas sim
em blocos, que são metades das partes.

Com esta mensagem, um \gls*{peer} pede por uma parte do \gls*{torrent}. A seção de dados
contém os seguintes números inteiros:

\begin{itemize}
    \item índice:
    \item início:
    \item tamanho:
\end{itemize}

\subsubsection*{piece}

\subsubsection*{cancel}

\subsubsection*{port}


\subsection*{Algoritmos}