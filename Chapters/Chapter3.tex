%!TEX root = ../tcc.tex

\chapter{Anatomia do BitTorrent}

O BitTorrent é uma rede \gls{p2p} onde cada um de seus usuários assume o papel híbrido
de servidor, que fornece os arquivos, e de cliente, que adquire os arquivos. Cada
computador é chamado de \gls{peer}.

Cada transferência por BitTorrent está associada a um arquivo de \glspl{metadata}
chamado \gls{torrent}. Esse arquivo contém informações sobre os arquivos que formam o
pacote de dados daquele conjunto de dados e também um ou mais endereços de
\glspl*{tracker}, que mantém listas atualizadas dos \glspl*{peer} que estão
compartilhando os dados, atualizado em períodos de tempo curtos (usualmente 30 minutos).

\begin{figure}[H]
    \centering
    \fbox{\includegraphics[width=0.64\textwidth]{torrent-basics.png}}
    \caption{esquema básico do funcionamento do BitTorrent. Fonte: \cite[p. 12]{conf:swarming}}
    \label{fig:torrent-basics}
\end{figure}

Enquanto um \gls*{peer} estiver fazendo download de um \gls*{torrent} é chamado de
\gls{leecher}, pois ainda estará consumindo dados de outros \glspl*{peer}; quando o
download acabar, passará a ser um \gls{seeder}, que somente envia dados para outros
\glspl*{peer}.

\begin{figure}[H]
    \centering
    \fbox{\includegraphics[width=0.85\textwidth]{swarming-universobt.png}}
    \caption{amostra de uma rede de conexões BitTorrent. Fonte: \cite[p. 13]{conf:swarming}}
    \label{fig:torrent-universo}
\end{figure}

Os arquivos \gls*{torrent} ficam disponíveis em vários sites de índice (às vezes
chamados de comunidades), como o \href{http://thepiratebay.sx/}{ThePirateBay}, o
\href{http://kickass.to/}{Kickass} ou \href{https://torrentz.eu/}{Torrentz}, muitas
vezes em mais de um deles ao mesmo tempo. Apesar de todo conteúdo compartilhado possuir
um arquivo \gls*{torrent}, não necessariamente um arquivo \gls*{torrent} está sendo
compartilhado, podendo inclusive estar extinto.

\Glspl*{peer} que participam do compartilhamento de um arquivo \gls*{torrent} específico
fazem parte do \gls{swarm}, onde os dados contidos no pacote desse arquivo são
compartilhados com outros de forma independente e paralela por partes.

\begin{figure}[H]
    \newlength{\myvsize}
    \newlength{\myhsize}
    \setlength{\myvsize}{5mm}
    \setlength{\myhsize}{0.28\textwidth}

    \centering

    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-0.png}}
        \caption{}
        \label{fig:torrent-repr-0}
    \end{subfigure}%
    \quad %add desired spacing between images (~, \quad, \qquad or blank line)
    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-1.png}}
        \caption{}
        \label{fig:torrent-repr-1}
    \end{subfigure}%
    \quad
    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-2.png}}
        \caption{}
        \label{fig:torrent-repr-2}
    \end{subfigure}

    \vspace{\myvsize}

    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-3.png}}
        \caption{}
        \label{fig:torrent-repr-3}
    \end{subfigure}%
    \quad
    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-4.png}}
        \caption{}
        \label{fig:torrent-repr-4}
    \end{subfigure}%
    \quad
    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-5.png}}
        \caption{}
        \label{fig:torrent-repr-5}
    \end{subfigure}

    \vspace{\myvsize}

    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-6.png}}
        \caption{}
        \label{fig:torrent-repr-6}
    \end{subfigure}%
    \quad
    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-7.png}}
        \caption{}
        \label{fig:torrent-repr-7}
    \end{subfigure}%
    \quad
    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-8.png}}
        \caption{}
        \label{fig:torrent-repr-8}
    \end{subfigure}

    \vspace{\myvsize}

    \begin{subfigure}[H]{\myhsize}
        \fbox{\includegraphics[width=\textwidth]{Torrentcomp_small-9.png}}
        \caption{}
        \label{fig:torrent-repr-9}
    \end{subfigure}

    \caption{Simulação de uma transferência torrent: o \gls{seeder}, na parte
    inferior das figuras, possui todas as 5 partes de um arquivo, que os outros
    computadores, os \glspl{leecher}, baixam de forma independente e paralela. Fonte:
    \cite{fig:torrent-dl}}
    \label{fig:torrent-repr}
\end{figure}

Todos esses agentes possuem relações de múltiplas entre si. Por exemplo, um mesmo
arquivo \gls*{torrent} pode estar indexado por vários sites indexadores. Como veremos
nos capítulos seguintes, eles contém uma informação que os identificam unicamente entre
si, mantendo a consistência de dados através desses vários sites de busca. Outra
observação a ser feita é que um \gls*{peer} pode estar baixando mais de um
\gls*{torrent} simultaneamente, ou seja, participando de 2 \glspl*{swarm} ao mesmo
tempo. Por fim, em alguns casos um arquivo \gls*{torrent} possui grande quantidade de
\glspl*{peer}, havendo necessidade de se dividir o \gls*{swarm} em algumas partes para
fins de escalabilidade da rede formada.

\section{Busca por informações}

Ao se adicionar um \gls*{torrent} em um programa cliente, ocorrem muitas transmissões de
dados antes do download de fato. Para demonstrar isso, usaremos um arquivo torrent do
filme ``A Noite dos Mortos Vivos'' de 1960 \cite{torrent-file}, que é de domínio público
e livre de direitos autorais.

Se abrirmos esse arquivo, veremos uma grande \gls{string}, caracteres diferentes e
incomuns, formando um conteúdo ilegível e de sob uma forma compacta, mostrado no
código~\ref{lst:torrent-file-raw}.

\begin{listing}[H]
    \begin{minted}[
        linenos,
        frame=single,
        numbersep=6pt,
        baselinestretch=1,
        fontfamily=courier,
        gobble=4,
        fontsize=\scriptsize
    ]{text}
    d8:announce36:http://bt1.archive.org:6969/announce13:announce-listll36:http://bt1.
    archive.org:6969/announceel36:http://bt2.archive.org:6969/announceee7:comment13:crea
    tiondatei1343715473e4:infod5:filesld5:crc328:030208fe6:lengthi4127671704e3:md532:627
    f5a428f9e454ccfcb29d31b87169a5:mtime10:10794024804:pathl29:night_of_the_living_dead.
    mpege4:sha140:5e44bb1b3f700240249a5287c64dc02dc56d034bee4:name24:night_of_the_living
    _dead12:piecelengthi4194304e6:pieces23720:<binary>

    (...)

    e6:locale2:en5:title24:night_of_the_living_dead8:url-listl28:http://archive.org/
    download/39:http://ia600301.us.archive.org/22/items39:http://ia700301.us.archive.
    org/22/itemsee
    \end{minted}

    \caption{trecho do conteúdo do arquivo .torrent do filme ``A Noite dos Mortos
    Vivos'', de 1960 \cite{torrent-file}, com a parte binária truncada}
    \label{lst:torrent-file-raw}
\end{listing}

Esse conteúdo está organizado usando o formato \gls{bencode}, que é um formato de
codificação compacta de arquivos especial para arquivos .torrent e não é legível ao ser
humano. Com alguma formatação grosseira, podemos enxergar os componentes separadamente,
como mostra o código~\ref{lst:torrent-file-code}.

\begin{listing}[ht!]
    \begin{minted}[
        linenos,
        frame=single,
        numbersep=6pt,
        baselinestretch=1,
        fontfamily=courier,
        gobble=4,
        fontsize=\scriptsize
    ]{text}
    d
        8:announce
        36:http://bt1.archive.org:6969/announce
        13:announce-list
        l
            l36:http://bt1.archive.org:6969/announcee
            l36:http://bt2.archive.org:6969/announcee
        e
        7:comment
        13:creation date
        i1343715473e
        4:info
        d
            5:files
            l
                d
                    5:crc32
                    8:030208fe
                    6:length
                    i4127671704e
                    3:md5
                    32:627f5a428f9e454ccfcb29d31b87169a
                    5:mtime
                    10:1079402480
                    4:path
                    l29:night_of_the_living_dead.mpege
                    4:sha1
                    40:5e44bb1b3f700240249a5287c64dc02dc56d034b
                e
            e
            4:name
            24:night_of_the_living_dead
            12:piece length
            i4194304e
            6:pieces
            23720:<binary>
        e
        6:locale
        2:en
        5:title
        24:night_of_the_living_dead
        8:url-list
        l
            28:http://archive.org/download/
            39:http://ia600301.us.archive.org/22/items
            39:http://ia700301.us.archive.org/22/items
        e
    e
    \end{minted}
    \caption{trechos formatados de forma legível do conteúdo do arquivo .torrent do
    filme ``A Noite dos Mortos Vivos'', de 1960 \cite{torrent-file}, com a parte
    binária truncada}
    \label{lst:torrent-file-code}
\end{listing}

\newpage

Esse conteúdo tem significado, sendo utilizado da seguinte forma
\cite{site:torrent-spec-wiki}:

\begin{itemize}
    \item \gls*{string} são prefixos de números na base 10 que representam
        comprimentos, seguidos por um caractere `:' e então o conteúdo. Por exemplo, na
        linha 2, \verb|8:announce| corresponde à \gls*{string} "announce".

    \item números são representados por um `i', seguidos do valor na base 10 (sem
        qualquer limite, mas sem zeros precedentes como em $0003$, e podendo ser
        negativo), e terminados por um `e'. Por exemplo, na linha 11,
        \verb|i1343715473e| corresponde ao número 1343715473.

    \item listas são formadas por `l', seguidos por seus elementos (também no formato
        \gls*{bencode}), e então terminados por `e'. Por exemplo, \verb|l3:foo3:bare|
        corresponde a ["foo", "bar"]. No código acima, é presente entre as linhas 43
        e 47.

    \item dicionários são definidos por `d', seguidos de uma lista alternada de chaves e
        seus valores correspondentes, terminando com `e', onde as chaves devem estar
        ordenadas usando-se comparação binária ao invés da usual alfanumérica.
        Por exemplo, a \gls*{string} \verb|d3:foo3:bar6:foobar6:bazbare| corresponde a
        \{"foo: "bar", "foobar": "bazbar"\}, e \verb|d3:fool6:foobar3:bazee| a
        \{"foo": ["foobar", "baz"]\}.
\end{itemize}

Além do arquivo \gls*{torrent}, existe uma outra forma de se transmitir os
\glspl*{metadata} necessários para se iniciar a transmissão, que é utilizando
\gls{magnetlink}.

\Glspl*{magnetlink}, ao contrário dos arquivos \gls*{torrent}, não estão gravados em
algum dispositivo de armazenamento. Basicamente, é um esquema de \gls{uri} usado
exclusivamente para o protocolo.

No caso citado, o site de origem do \gls*{torrent} que estamos usando não fornece um
\gls*{magnetlink} oficialmente. Porém, o Transmission consegue construir uma \gls*{uri}
a partir do arquivo original, para fins de compartilhamento direto. O resultado, após
decodificar o endereço para um formato legível (retirando a codificação de caracteres
especiais \cite{wiki:urlencode}) foi o seguinte:

\begin{listing}[ht!]
    \begin{minted}[
        linenos,
        frame=single,
        numbersep=6pt,
        baselinestretch=1,
        fontfamily=courier,
        gobble=4,
        fontsize=\scriptsize
    ]{text}
    magnet:?xt=urn:btih:72d7a3179da3de7a76b98f3782c31843e3f818ee
    &dn=night_of_the_living_dead
    &tr=http://bt1.archive.org:6969/announce&tr=http://bt2.archive.org:6969/announce
    &ws=http://archive.org/download/
    &ws=http://ia600301.us.archive.org/22/items/&ws=http://ia700301.us.archive.org/22/items/
    \end{minted}
    \caption{\gls*{magnetlink} do arquivo .torrent do filme ``A Noite dos Mortos Vivos''
    , de 1960 \cite{torrent-file}, com parâmetros divididos entre linhas para melhor
    visualização}
    \label{lst:torrent-file-magnet-link}
\end{listing}

Esse endereço é composto por vários pares de nomes de parâmetros (sem qualquer ordem
específica) e seus respectivos valores, formando uma \gls{querystring}. Podemos
dividir esse endereço em partes, cada uma tendo o seu significado:

\begin{itemize}
    \item \verb|xt|: parâmetro para \emph{exact topic}, ou tópico exato, contém a
        informação mais importante do \gls*{magnetlink}, que serve para encontrar e
        verificar os arquivos especificados. No caso, \verb|urn:btih:<hash>|
        corresponde ao \gls{urn} btih (\emph{BitTorrent Info Hash}), cujo
        \gls{hashvalue} é o valor convertido para hexadecimal fornecido pela
        \gls{hashfunction} SHA-1 (ver seção~\ref{sec:sha1})

    \item \verb|dn|: parâmetro que contém o \emph{display name}, ou nome de
        visualização, contém um nome que é mostrado para o usuário, por conveniência

    \item \verb|tr|: o \emph{address tracker}, ou endereço do \gls*{tracker}, onde o
        programa cliente vai procurar as informações de \glspl*{peer}

    \item \verb|ws|: endereço do arquivo para \emph{webseed}, ou fornecimento web,
        que é o endereço do arquivo em um servidor HTTP ou FTP, sendo utilizado como
        alternativa a um \gls*{swarm} problemático \cite{wiki:torrent}
\end{itemize}



\todo[inline]{explicar como o Transmission usa o torrent}

\section{Fontes de arquivos}

Mostrarei o processamento dos dados adquiridos na seção anterior e como ele organiza a lista das fontes de arquivos usando a tabela hash DHT Kademlia.

\section{Jogo da troca de arquivos}

Explicarei o algoritmo tit-for-tat padrão do protocolo BitTorrent, que vem da Teoria dos Jogos, e como o Transmission o implementa.

\afterpage{\clearpage}